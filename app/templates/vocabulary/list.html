{% extends "base.html" %}

{% block title %}Vocabulary - VocabExt{% endblock %}

{% block content %}
<hgroup>
    <h1>Vocabulary</h1>
    <p>{{ total_count }} words | {{ synced_count }} synced to Anki</p>
</hgroup>

<div class="actions-bar">
    <form method="get" action="/vocabulary" class="filter-form">
        <div class="filter-row">
            <input type="text" name="search" placeholder="Search lemma..." value="{{ search }}">
            <select name="pos">
                <option value="">All POS</option>
                {% for p in pos_values %}
                <option value="{{ p }}" {% if p == pos %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
            <select name="sync_status">
                <option value="">All Sync</option>
                <option value="synced" {% if sync_status == 'synced' %}selected{% endif %}>Synced</option>
                <option value="unsynced" {% if sync_status == 'unsynced' %}selected{% endif %}>Unsynced</option>
                <option value="needs_resync" {% if sync_status == 'needs_resync' %}selected{% endif %}>Needs Re-sync</option>
            </select>
            <select name="version">
                <option value="">All Versions</option>
                <option value="v1" {% if version == 'v1' %}selected{% endif %}>v1 only</option>
                <option value="v2+" {% if version == 'v2+' %}selected{% endif %}>v2+</option>
            </select>
            <select name="updated_within">
                <option value="">Any Time</option>
                <option value="1" {% if updated_within == '1' %}selected{% endif %}>Last 24h</option>
                <option value="7" {% if updated_within == '7' %}selected{% endif %}>Last 7 days</option>
                <option value="30" {% if updated_within == '30' %}selected{% endif %}>Last 30 days</option>
            </select>
            <select name="review_status">
                <option value="">All Review</option>
                <option value="needs_review" {% if review_status == 'needs_review' %}selected{% endif %}>Needs Review</option>
                <option value="reviewed" {% if review_status == 'reviewed' %}selected{% endif %}>Reviewed</option>
            </select>
            <button type="submit">Filter</button>
        </div>
    </form>

    <div class="action-buttons">
        <button hx-post="/sync"
                hx-target="#sync-status"
                hx-swap="innerHTML"
                hx-indicator="#sync-spinner"
                hx-disabled-elt="this">
            Sync to Anki
        </button>
        <span id="sync-spinner" class="htmx-indicator" aria-busy="true">Syncing...</span>

        <button id="batch-validate-btn" class="secondary" onclick="startBatchValidation()">
            Batch Validate ({{ words|length }} words)
        </button>
    </div>
</div>

<div id="sync-status"></div>

<div id="batch-progress" class="batch-progress" style="display: none;">
    <div class="progress-header">
        <span id="progress-text">Starting...</span>
        <button type="button" class="outline" onclick="cancelBatchValidation()">Cancel</button>
    </div>
    <progress id="progress-bar" value="0" max="100"></progress>
    <div id="progress-stats"></div>
</div>

{% if words %}
<table class="vocabulary-table">
    <thead>
        <tr>
            <th>Word</th>
            <th>Translations</th>
            <th>Grammar</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for word in words %}
        {% include "partials/word_row.html" %}
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No vocabulary words found. Upload and review documents to build your vocabulary.</p>
{% endif %}

<script>
let eventSource = null;

function startBatchValidation() {
    document.getElementById('batch-progress').style.display = 'block';
    document.getElementById('batch-validate-btn').disabled = true;
    document.getElementById('progress-stats').textContent = '';

    // Pass current filters to the SSE endpoint
    const params = new URLSearchParams(window.location.search);
    eventSource = new EventSource('/vocabulary/batch-validate/stream?' + params);

    eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'progress') {
            document.getElementById('progress-bar').value = (data.completed / data.total) * 100;
            document.getElementById('progress-text').textContent =
                `${data.completed}/${data.total}: ${data.word}`;
        } else if (data.type === 'error') {
            console.error('Batch validation error:', data.word, data.error);
        } else if (data.type === 'complete') {
            eventSource.close();
            document.getElementById('progress-text').textContent = 'Complete!';
            document.getElementById('progress-stats').textContent =
                `Modified: ${data.modified} | Skipped: ${data.skipped} | Flagged: ${data.flagged} | Errors: ${data.errors}`;
            document.getElementById('batch-validate-btn').disabled = false;
            // Reload page after delay to show updated data
            setTimeout(() => location.reload(), 3000);
        }
    };

    eventSource.onerror = () => {
        eventSource.close();
        document.getElementById('progress-text').textContent = 'Connection lost. Processed words have been saved.';
        document.getElementById('batch-validate-btn').disabled = false;
    };
}

function cancelBatchValidation() {
    if (eventSource) {
        eventSource.close();
    }
    location.reload();
}
</script>
{% endblock %}
